{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>HnaFinGENI Chat</title>
    <link rel="stylesheet" href="{% static 'chatbot/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Navbar -->
        <nav class="top-nav">
            <div class="logo">HnaFinGENI</div>
            <div class="model-buttons">
                <button>Model 1</button>
                <button>Model 2</button>
                <button>Model 3</button>
            </div>
            <div class="right-icons">
                <i class="fas fa-user-circle profile-icon"></i>
            </div>
        </nav>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Sidebar -->
            <aside class="left-sidebar">
                <button class="new-chat" onclick="window.location.href='{% url 'new_chat' %}'">
                    <i class="fas fa-plus"></i> New Chat
                </button>
                <div class="chat-history">
                    <h4>Conversations</h4>
                    <ul>
                        {% for conv in conversations %}
                        <li style="cursor:pointer;" data-url="{% url 'chat_home' conv.conversation_id %}"
                            class="{% if conv.conversation_id == conversation_id %}active{% endif %}">
                            <i class="fas fa-comments" style="padding-right:10px;"></i>
                            {{ conv.conversation_id }}
                            <button class="delete-btn" data-id="{{ conv.conversation_id }}">
                                <i class="fas fa-trash"></i>
                        </li>
                        {% empty %}
                        <li>‚ö†Ô∏è No conversations</li>
                        {% endfor %}
                    </ul>
                </div>
            </aside>

            <!-- Center Content -->
            <main class="center-content">
                <div class="chat-messages" id="chat-messages">
                    {% for msg in messages %}
                    {% if msg.role == "user" %}
                    <div class="message user">
                        <div class="user-message-wrapper">
                            <div class="user-content">
                                <!-- <p class="user-text"> -->
                                <div class="response-box">
                                    {{ msg.content | safe }}
                                </div>
                                <!-- </p> -->
                            </div>
                            <div class="avatar user-avatar"><i class="fas fa-user-circle"></i></div>
                        </div>
                    </div>
                    {% else %}
                    <div class="message bot">
                        <div class="bot-message-wrapper">
                            <div class="avatar bot-avatar"><i class="fas fa-robot"></i></div>
                            <div class="bot-content">
                                <!-- <h2>Response</h2> -->
                                <div class="response-box">
                                    <p>{{ msg.content | safe }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% empty %}
                    <p>Ch∆∞a c√≥ message n√†o trong conversation n√†y.</p>
                    {% endfor %}
                </div>

                <!-- Input Area -->
               <div class="input-area">
    <!-- n√∫t summary -->
    <button id="summary-btn" type="button" class="summary-btn" disabled>
        <i class="fas fa-file-alt"></i> Summary
    </button>

    <div class="chat-input-wrapper">
        <!-- n√∫t upload file -->
        <label for="file-upload" class="file-upload-icon">
            <i class="fas fa-paperclip"></i>
            <input id="file-upload" type="file" name="file" style="display:none;">
        </label>

        <!-- textarea -->
        <textarea id="message-input" placeholder="Type your message..." rows="1"></textarea>

        <!-- n√∫t g·ª≠i -->
        <button id="send-btn" type="button"><i class="fas fa-paper-plane"></i></button>
    </div>

    <!-- preview file -->
    <div class="file-preview" id="file-preview" style="display:none;">
        <span class="file-name" id="file-name"></span>
        <span class="file-size" id="file-size"></span>
        <button type="button" class="clear-file" id="clear-file">X</button>
    </div>
</div>
            </main>

            <!-- Right Sidebar -->
            <aside class="right-sidebar">
                <h3>Ch·ªçn b√°o c√°o t√†i ch√≠nh ƒë√£ x·ª≠ l√Ω</h3>

                <form id="report-selection-form">
                    {% if uploaded_reports %}
                        {% for report in uploaded_reports %}
                            <div class="report-option">
                                <input type="radio" 
                                    name="selected_report" 
                                    id="report-{{ forloop.counter }}" 
                                    value="{{ report.id }}"
                                    {% if selected_report_id and report.id == selected_report_id %}checked{% endif %}>
                                <label for="report-{{ forloop.counter }}">
                                    {{ report.file_name }}
                                </label>

                                <a href="http://127.0.0.1:8000/media/{{ report.file_name }}.pdf" 
                            target="_blank" 
                            class="open-file-link" 
                            title="M·ªü b√°o c√°o g·ªëc">
                                <i class="fas fa-link"></i>
                            </a>
                                        </div>
                        {% endfor %}
                    {% else %}
                        <p>‚ö†Ô∏è Ch∆∞a c√≥ b√°o c√°o n√†o ƒë∆∞·ª£c t·∫£i l√™n.</p>
                    {% endif %}
                </form>

                <hr>

                <h3>Generated Links of Websites and Documents will appear here</h3>
            </aside>
        </div>
    </div>

    <script>
        // --- File preview ---
        const fileInput = document.getElementById('file-upload');
        const filePreview = document.getElementById('file-preview');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const clearBtn = document.getElementById('clear-file');

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                filePreview.style.display = 'flex';
                fileName.textContent = file.name;
                fileSize.textContent = `(${(file.size / 1024).toFixed(2)} KB)`;
            }
        });

        clearBtn.addEventListener('click', () => {
            fileInput.value = '';
            filePreview.style.display = 'none';
        });

        // --- Navigate conversation ---
        document.querySelectorAll('li[data-url]').forEach(li => {
            li.addEventListener('click', () => {
                location.href = li.getAttribute('data-url');
            });
        });

        // --- Auto scroll ---
        function scrollToBottom() {
            const chatMessages = document.getElementById("chat-messages");
            if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function typeEffect(element, text, speed = 3) {
            let i = 0;
            element.textContent = "";
            let timer = setInterval(() => {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                } else {
                    clearInterval(timer);
                }
            }, speed);
        }

        window.addEventListener("load", scrollToBottom);

        // --- Chat send ---
        const sendBtn = document.getElementById("send-btn");
        const messageInput = document.getElementById("message-input");
        const chatMessages = document.getElementById("chat-messages");

        function appendMessage(role, content, isLoading = false, isHtml = false, suggestions = []) {
            let div = document.createElement("div");
            div.classList.add("message", role === "user" ? "user" : "bot");
            if (isLoading) div.setAttribute("id", "loading-msg");

            if (role === "bot") {
                div.innerHTML = `
                <div class="bot-message-wrapper">
                    <div class="avatar bot-avatar"><i class="fas fa-robot"></i></div>
                    <div class="bot-content">
                        <h2>Response</h2>
                        <div class="response-box">
                            ${isHtml ? content : `<p>${content}</p>`}
                        </div>
                </div>
            </div>
        `;

                // N·∫øu c√≥ suggestions th√¨ th√™m n√∫t g·ª£i √Ω
                if (suggestions.length > 0) {
                    let sugDiv = document.createElement("div");
                    sugDiv.classList.add("bottom-buttons");
                    suggestions.forEach(sug => {
                        let btn = document.createElement("button");
                        btn.innerText = sug;
                        btn.onclick = () => {
                            messageInput.value = sug;  // g√°n v√†o input
                            messageInput.focus();
                        };
                        sugDiv.appendChild(btn);
                    });
                    div.querySelector(".bot-content").appendChild(sugDiv);
                }

            } else {
                div.innerHTML = `
            <div class="user-message-wrapper">
                <div class="user-content"><p class="user-text">${content}</p></div>
                <div class="avatar user-avatar"><i class="fas fa-user-circle"></i></div>
            </div>
        `;
            }

            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        sendBtn.addEventListener("click", () => {
            const message = messageInput.value.trim();
            const file = fileInput.files[0];

            if (!message && !file && !selectedReportId) {
                appendMessage("bot", "B·∫°n ch∆∞a ƒë∆∞a ra c√¢u h·ªèi n√†o.");
                return;
            }

            if (message) appendMessage("user", message);
            appendMessage("bot", "‚è≥ ƒêang x·ª≠ l√Ω...", true);

            const formData = new FormData();
            formData.append("message", message);

            // ‚úÖ N·∫øu ng∆∞·ªùi d√πng ch·ªçn radio file b√°o c√°o, g·ª≠i c·∫£ t√™n file
            if (selectedReportId) {
                const selectedRadio = document.querySelector(`input[name="selected_report"][value="${selectedReportId}"]`);
                const selectedLabel = selectedRadio ? selectedRadio.nextElementSibling.textContent.trim() : "";
                formData.append("selected_report_id", selectedReportId);
                formData.append("selected_report_name", selectedLabel);
            }

            // ‚úÖ N·∫øu ng∆∞·ªùi d√πng upload file tr·ª±c ti·∫øp
            if (file) formData.append("file", file);

            fetch("{% url 'chat_send' conversation_id=conversation_id %}", {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("loading-msg")?.remove();
                    if (data.response) {
                        appendMessage("bot", data.response, false, true, data.suggestions || []);
                    }

                    sendBtn.disabled = false;
                    sendBtn.classList.remove("disabled-btn");
                })
                .catch(err => {
                    console.error(err);
                    sendBtn.disabled = false;
                    sendBtn.classList.remove("disabled-btn");
                });

            // ‚úÖ v√¥ hi·ªáu h√≥a n√∫t g·ª≠i khi ƒëang x·ª≠ l√Ω
            sendBtn.disabled = true;
            sendBtn.classList.add("disabled-btn");

            messageInput.value = "";
            fileInput.value = "";
            filePreview.style.display = "none";
        });
                
        
        const textarea = document.getElementById("message-input");
        textarea.addEventListener("input", () => {
            textarea.style.height = "auto";
            textarea.style.height = (textarea.scrollHeight) + "px";
        });

        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation(); // kh√¥ng cho trigger click v√†o li
                const convId = btn.getAttribute("data-id");

                if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° cu·ªôc tr√≤ chuy·ªán n√†y kh√¥ng?")) {
                    fetch(`/delete/${convId}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        }
                    })
                        .then(res => {
                            if (res.ok) {
                                btn.closest("li").remove(); // xo√° kh·ªèi giao di·ªán
                                window.location.href = "{% url 'chat_home' %}";
                            } else {
                                alert("X√≥a th·∫•t b·∫°i!");
                            }
                        });
                }
            });
        });

        let selectedReportId = null;

        document.querySelectorAll('input[name="selected_report"]').forEach(radio => {
            radio.addEventListener('change', () => {
                selectedReportId = radio.value;
                console.log("Selected report ID:", selectedReportId);
            });
        });

        const summaryBtn = document.getElementById("summary-btn");

// C·∫≠p nh·∫≠t tr·∫°ng th√°i enable/disable c·ªßa summary button
function updateSummaryButtonState() {
    const hasFile = fileInput.files.length > 0;
    const hasSelectedReport = !!selectedReportId;
    summaryBtn.disabled = !(hasFile || hasSelectedReport);
}

// L·∫Øng nghe s·ª± ki·ªán upload file
fileInput.addEventListener('change', updateSummaryButtonState);
clearBtn.addEventListener('click', updateSummaryButtonState);

// L·∫Øng nghe s·ª± ki·ªán ch·ªçn radio
document.querySelectorAll('input[name="selected_report"]').forEach(radio => {
    radio.addEventListener('change', () => {
        selectedReportId = radio.value;
        updateSummaryButtonState();
    });
});

// Khi nh·∫•n n√∫t Summary
summaryBtn.addEventListener("click", () => {
    const file = fileInput.files[0];
    if (!file && !selectedReportId) {
        appendMessage("bot", "B·∫°n c·∫ßn upload ho·∫∑c ch·ªçn b√°o c√°o tr∆∞·ªõc khi t·∫°o b·∫£n t√≥m t·∫Øt.");
        return;
    }

    appendMessage("bot", "üßæ ƒêang t·∫°o b·∫£n ph√¢n t√≠ch t√≥m t·∫Øt...", true);

    const formData = new FormData();
    formData.append("isSummary", "true"); // ‚úÖ g·ª≠i c·ªù isSummary
    if (file) formData.append("file", file);
    if (selectedReportId) {
        const selectedRadio = document.querySelector(`input[name="selected_report"][value="${selectedReportId}"]`);
        const selectedLabel = selectedRadio ? selectedRadio.nextElementSibling.textContent.trim() : "";
        formData.append("selected_report_id", selectedReportId);
        formData.append("selected_report_name", selectedLabel);
    }

    fetch("{% url 'chat_send' conversation_id=conversation_id %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: formData
    })
        .then(res => res.json())
        .then(data => {
            document.getElementById("loading-msg")?.remove();
            if (data.response) {
                const pdfRegex = /(https?:\/\/[^\s]+\.pdf|\/[^\s]+\.pdf)/;
                let content = data.response;

                const match = data.response.match(pdfRegex);
                if (match) {
                    const url = match[0];
                    content = `ƒê√£ ph√¢n t√≠ch xong: <a href="${url}" target="_blank" class="pdf-link">${url}</a>`;
                }

                appendMessage("bot", content, false, true, data.suggestions || []);
            }
        })
        .catch(err => {
            console.error(err);
            appendMessage("bot", "‚ùå L·ªói khi t·∫°o b·∫£n t√≥m t·∫Øt.");
        });
});

    </script>
</body>

</html>